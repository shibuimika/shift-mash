# SHIFT MASH（地域シフト循環）要件定義 v0.3  
*for Cursor × Claude 4 Sonnet 開発*

---

## 0. サマリー
- **目的**：当日発生する「人員不足（欠勤）」と「人員余剰（想定より暇）」を、同一エリア内の複数店舗で相互補完する。
- **価値**：
  - 不足店：営業品質と売上の毀損を回避
  - 余剰店：人件費ロス／早上がり不満を回避
  - アルバイト：予定収入・勤務時間を維持、他店実績が可視化
- **UIの核**：シフト枠の**上側に重ねる2つのボタン**—「人員募集」「他店舗に派遣」＋ **候補リストモーダル**（0件時は即公開メッセージ）
- **成立ルール**：相手店舗の**承認先着**で成立。募集/派遣とも同じ。ステータスは「公開中」か「成立/取り消し」のみ（当日運用のため最小）。

---

## 1. 対象ユーザーとゴール
- **店長（単店舗）**：当日の不足/余剰を最短手数で対処。シフト表だけで完結。
- **エリアマネ**（将来拡張）：全体の不足/余剰の状況把握（今回MVPでは軽いサマリのみ）
- **アルバイト**：自店余剰→他店応援／他店からの指名に承諾しやすい体験（本MVPでは店舗間合意後は“直接連絡”でOK）

---

## 2. スコープ（MVP）
### In
- 当日シフトの**不足登録（店長手入力）**
- 役割一致（ホール/キッチン等）での候補提示
- 2ボタン：
  - **人員募集**（不足側）→ 他店の**派遣可能人材**リスト
  - **他店舗に派遣**（余剰側）→ 他店の**募集枠**リスト
- リクエスト送信（**複数選択可**）→ 相手側の**承認/拒否**
- **先着承認**でマッチ成立、シフト両側に反映
- 0件時は「公開」メッセージのみ（募集/派遣可能の公開）
- ダミーデータで動作（地図は静的画像可）

### Out（割り切り）
- 給与/労務/保険の本格処理、交通費精算
- 打刻・給与連動（将来：QR打刻等）
- 複雑なステータス管理（当日は「公開中」/「成立」/「取消」のみ）

---

## 3. 主要ユースケース
### UC-1 不足を埋める（人員募集）
1. 店長が**欠勤を手入力**→不足枠が赤表示
2. シフト枠**上側ボタン**「人員募集」をタップ
3. モーダル表示：対象**時間・役割・人数**を自動セット
4. システムが**派遣可能人材**を検索（役割一致必須）
   - **候補がある**：チェック選択→**リクエスト送信**
   - **候補0件**：\"該当なし→募集を公開しました\"（OKでクローズ）
5. 相手側店舗が**承認**した時点で成立（**先着**）。

### UC-2 余剰を活かす（他店舗に派遣）
1. 余剰枠が青表示
2. シフト枠**上側ボタン**「他店舗に派遣」をタップ
3. モーダル表示：対象**時間・役割・人数**を自動セット
4. システムが**他店の募集枠**を検索（役割一致必須）
   - **募集がある**：チェック選択→**リクエスト送信**
   - **募集0件**：\"現在募集はありません→派遣可能として公開しました\"
5. 受け入れ店舗の**承認先着**で成立。

### UC-3 バイネーム指名（任意）
- 候補リスト上部に**名前検索**を設置。店長が特定のアルバイトを直接指定してリクエスト送信できる。

---

## 4. 画面/コンポーネント設計
### 4.1 ページ構成
- `/day`：当日シフト日表示（デフォルト）
- `/inbox`：受信リクエスト一覧（承認/拒否）※簡易でOK
- `/overview`：不足/余剰件数サマリ（数カードのみ）

### 4.2 主要コンポーネント
- `ShiftCell`：時間バー + **上側オーバーレイボタン**（人員募集/他店舗に派遣）
- `RequestModal`
  - Header：タイトル（人員募集/派遣可能）+ 対象条件（時間・役割・人数）
  - Body：
    - **候補リスト**（不足側→人材リスト / 余剰側→募集枠リスト）
    - **0件時**メッセージ（募集公開/派遣可能公開）
  - Footer：`キャンセル` / `リクエスト送信`
- `RequestInboxList`：受信リクエストの承認/拒否
- `Toast`：成立/拒否/競合での通知

### 4.3 UI仕様（抜粋）
- **ボタン位置**：各シフト枠の**上辺に重ねる**（モバイルでも押しやすい高さ）
- **カラー**：不足=赤系 / 余剰=青系。ボタンは薄色塗り + 枠線濃色。
- **0件時モーダル**：本文中央に文言、フッターは`OK`のみ。

---

## 5. 成立ロジック（簡易）
- **マッチ条件**：`役割一致（必須） ∧ 時間帯重なり ∧ 店舗間移動可能`
- **並び順**（不足側の候補人材）：距離→評価→最近の出動回数（低い順）
- **承認先着**：受信側が`承認`した瞬間に確定。他の未処理リクエストは自動で`無効`。
- **公開の消滅条件**：
  - 募集：成立 or 店長が取り消し
  - 派遣可能：成立 or 店長が取り消し

---

## 6. データモデル（モック）
```json
// stores.json
[
  {"id":"s1","name":"北浦和店","lat":35.0,"lng":139.6},
  {"id":"s2","name":"与野店","lat":35.01,"lng":139.61}
]
```
```json
// workers.json
[
  {"id":"w1","name":"佐藤 太郎","storeId":"s1","roles":["hall"],"rating":4.6},
  {"id":"w2","name":"鈴木 花子","storeId":"s2","roles":["kitchen"],"rating":4.3}
]
```
```json
// shifts.json （当日分）
[
  {"id":"sh1","storeId":"s1","role":"hall","start":"09:00","end":"12:00","status":"shortage"},
  {"id":"sh2","storeId":"s2","role":"hall","start":"14:00","end":"17:00","status":"surplus"}
]
```
```json
// publishings.json  （公開エンティティ）
{
  "recruitings": [
    {"id":"r1","storeId":"s1","role":"hall","start":"09:00","end":"12:00","open":true}
  ],
  "availables": [
    {"id":"a1","storeId":"s2","workerId":"w1","role":"hall","start":"14:00","end":"17:00","open":true}
  ]
}
```
```json
// requests.json （双方向リクエスト）
[
  {"id":"req1","from":"s1","to":"s2","type":"recruiting", "targetIds":["w1"], "shiftId":"sh1", "createdAt":1710000000},
  {"id":"req2","from":"s2","to":"s1","type":"dispatch",   "targetIds":["r1"],  "shiftId":"sh2", "createdAt":1710000100}
]
```
> 補足：ステータスは画面表示しないが、内部的には `approvedAt` の有無で**先着確定**を判定する。

---

## 7. 受信側の承認UI（簡易仕様）
- `/inbox` にカードを並べる：
  - タイトル：`[人員募集] 北浦和店（09:00-12:00 / ホール）`
  - 本文：候補（人材 or 募集）の要点
  - ボタン：`承認` / `拒否`
- **承認**クリック → 該当の公開エンティティを`open=false`にし、関連する未処理リクエストを無効化 → 両シフトに反映

---

## 8. 非機能/設計指針
- **UIトーン**：Airシフト/ワーク調（清潔・安心）。モバイルファースト。
- **技術選定（デモ安定重視）**：
  - **Vite + React + TypeScript + Tailwind v3**（SSR不要）
  - UI: HeadlessUI or shadcn/ui（必要最小限）
  - 状態管理: React Query + ローカルJSON（擬似API）
  - 地図：静的画像 + 距離/ETAは擬似（`distanceKm / 4kmh + 5min`）
- **避ける**：Turbopack / Tailwind v4（過去のビルド不安を回避）

---

## 9. 受け入れ基準（Acceptance Criteria）
- [ ] シフト枠上に「人員募集」「他店舗に派遣」ボタンが表示される
- [ ] モーダルに対象**時間・役割・人数**が自動セットされる
- [ ] 候補/募集が**1件以上**ならリストに表示、複数選択→リクエスト送信できる
- [ ] **0件**なら公開メッセージで終了し、公開状態が保持される
- [ ] 受信側で**承認**したものが**先着**で成立、他は無効化される
- [ ] 成立すると両側のシフト表示が更新される（応援勤務として可視）

---

## 10. デモシナリオ（台本）
1. 09:00-12:00 ホールで欠勤 → `人員募集` → 候補0件 → 募集公開
2. 14:00-17:00 与野店に余剰 → `他店舗に派遣` → 北浦和店の募集がヒット → チェック送信
3. 北浦和店が承認（先着） → 両側に応援勤務が反映

---

## 11. Cursor / Claude 4 Sonnet 用・初回プロンプト
> 以下を **Cursorに貼り付け**、Claude 4 Sonnet を選んで実行してください。
```
あなたはフロントエンドエンジニアです。Vite + React + TypeScript + Tailwind v3 で、次のMVPを1リポジトリで実装してください。

【要件要約】
- 当日シフト表（/day）に、各シフト枠の上側へ「人員募集」「他店舗に派遣」ボタンを重ねて表示。
- ボタン押下でモーダル。対象の時間・役割・人数を自動セット。
- 不足側モーダル：派遣可能人材リスト（0件なら公開メッセージ）。
- 余剰側モーダル：他店の募集枠リスト（0件なら公開メッセージ）。
- リストは複数選択→リクエスト送信。受信側は /inbox で承認/拒否。
- 承認**先着**で成立、他は自動無効化。成立時に両シフトを更新。
- ダミーデータは /mock/*.json からフェッチ。距離/ETAは擬似計算。

【設計指示】
- ディレクトリ: src/components, src/pages, src/lib, public/mock
- 主要コンポーネント: ShiftCell, RequestModal, RequestInboxList, Toast
- UIはモバイルファーストでシンプル（Airシフト調）。
- 依存: react-router, tailwindcss@^3, @tanstack/react-query
- 擬似API: fetchで public/mock/*.json を読み込み、ローカル状態で更新。
- 競合制御：承認クリック時に in-memory Lock を取り、既に確定済みならトーストで失効通知。
- ESLint/Prettierを導入、型は厳格（no-explicit-any）。
- 最小のe2e的動作確認シードを含める（台本通り）。
```

---

## 12. 将来拡張（参考）
- QR打刻、評価バッジ、プリファレンス（移動半径・NG時間）
- フェアネス補正、通知（Push/Webhook）
- エリア俯瞰のKPIカード（充足率、承認速度）

---

## 付録：文言（例）
- 候補0件（不足側）：**「該当する候補は現在いません。募集を公開しました。」**
- 募集0件（余剰側）：**「現在募集はありません。派遣可能として公開しました。」**
- 承認競合：**「すでに他店舗で成立しました。募集/派遣可能を更新してください。」**

